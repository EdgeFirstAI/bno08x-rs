# GitHub Actions workflow for testing and code quality
#
# This workflow runs tests, performs static analysis, and collects coverage data
# for the BNO08x driver. Coverage is reported to SonarCloud.
#
# Action Versions (hash-pinned per SPS v2.1):
# - actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 (v6.0.0)
# - dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e (master)
# - actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 (v4.3.0)
# - taiki-e/install-action@92e6dd1c202153a204d471a3c509bf1e03dcfa44 (v2.62.61)
# - actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 (v5.0.0)
# - actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 (v6.0.0)
# - SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602 (v6.0.0)
#
# Runner Notes:
# - ubuntu-22.04: Standard GitHub-hosted runner (x86_64)
# - ubuntu-22.04-arm: Custom larger runner (ARM64)
# - raivin: Custom hardware runner with BNO08x sensor for integration tests

name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_call:  # Allow other workflows to call this

env:
  CARGO_TERM_COLOR: always

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e  # master
        with:
          toolchain: nightly
          components: rustfmt

      - name: Check formatting
        run: cargo +nightly fmt --all --check

  clippy:
    name: Lint with Clippy
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e  # master
        with:
          toolchain: stable
          components: clippy

      - name: Cache cargo registry
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
        with:
          path: ~/.cargo/registry/index
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
        with:
          path: target
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-clippy-

      - name: Run Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  test:
    name: Unit Tests (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.runner }}
    permissions:
      contents: read
      checks: write
      pull-requests: write
    strategy:
      matrix:
        platform:
          - name: x86_64
            runner: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
          - name: aarch64
            runner: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Install Rust
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e  # master
        with:
          toolchain: stable
          components: llvm-tools-preview
          targets: ${{ matrix.platform.target }}

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@92e6dd1c202153a204d471a3c509bf1e03dcfa44  # v2.62.61
        with:
          tool: cargo-llvm-cov,cargo-nextest

      - name: Cache cargo registry
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
        with:
          path: ~/.cargo/registry/index
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.platform.name }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-${{ matrix.platform.name }}-cargo-test-

      - name: Run unit and doc tests with coverage
        run: |
          # Run tests with JUnit XML and LCOV coverage output using profiling profile (optimized + debug symbols)
          # --profile profiling = nextest profile, --cargo-profile profiling = cargo profile
          cargo llvm-cov nextest --lib --workspace --lcov --output-path coverage.lcov --profile profiling --cargo-profile profiling --no-fail-fast

          # Run doc tests separately (nextest doesn't support doc tests)
          cargo test --doc --workspace --profile profiling --no-fail-fast

      - name: Publish Test Report
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: Test Results (${{ matrix.platform.name }})
          path: target/nextest/profiling/junit.xml
          reporter: java-junit
          fail-on-error: false

      - name: Build instrumented test archive for hardware testing (aarch64 only)
        if: matrix.platform.name == 'aarch64'
        run: |
          # Build test archive using profiling profile (optimized + debug symbols)
          # This reuses the already-built instrumented binaries from the test step above
          # Create nextest archive with profiling build for hardware testing
          cargo nextest archive \
            --archive-file hardware-tests.tar.zst \
            --workspace \
            --profile profiling \
            --cargo-profile profiling

          echo "Created nextest archive:"
          ls -lh hardware-tests.tar.zst

      - name: Upload coverage artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: coverage-${{ matrix.platform.name }}
          path: coverage.lcov
          retention-days: 30

      - name: Upload test archive for hardware testing (aarch64 only)
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        if: matrix.platform.name == 'aarch64'
        with:
          name: hardware-tests-archive
          path: hardware-tests.tar.zst
          retention-days: 7

      - name: Upload Rust instrumented objects for coverage processing (aarch64 only)
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        if: matrix.platform.name == 'aarch64'
        with:
          name: rust-llvm-cov-aarch64
          path: |
            target/llvm-cov-target/
          retention-days: 7

  hardware-test:
    name: Hardware Integration Tests
    needs: test
    runs-on: raivin
    # Only run on main branch or when explicitly requested via label
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'test-hardware')

    steps:
      - name: Clean workspace (self-hosted runner)
        run: |
          # Self-hosted runners persist state between runs
          rm -rf target/ integration-tests/ coverage/ 2>/dev/null || true
          find . -name "*.profraw" -delete 2>/dev/null || true

      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e  # master
        with:
          toolchain: stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@92e6dd1c202153a204d471a3c509bf1e03dcfa44  # v2.62.61
        with:
          tool: cargo-nextest

      - name: Download test archive
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          name: hardware-tests-archive
          path: .

      - name: Run hardware integration tests from archive
        run: |
          # Set up profraw collection directory for coverage
          mkdir -p coverage/profraw
          export LLVM_PROFILE_FILE="${{ github.workspace }}/coverage/profraw/raivin-%p-%m.profraw"

          # Extract and run tests from nextest archive with profiling profile
          # --profile profiling = use profiling nextest profile (matches archive)
          # --run-ignored=ignored-only to run only tests marked with #[ignore]
          # --test-threads=1 for deterministic execution on hardware
          # --no-fail-fast to run all tests even if some fail
          cargo nextest run \
            --archive-file hardware-tests.tar.zst \
            --profile profiling \
            --test-threads=1 \
            --no-fail-fast \
            --run-ignored=ignored-only

          echo ""
          echo "=== Profraw files generated ==="
          ls -la coverage/profraw/ || echo "No profraw files generated"

      - name: Publish Hardware Test Report
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: Test Results (Hardware - raivin)
          path: target/nextest/profiling/junit.xml
          reporter: java-junit
          fail-on-error: false

      - name: Upload hardware coverage artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        if: always()
        with:
          name: coverage-hardware
          path: |
            coverage/profraw/
          retention-days: 30

  process-hardware-coverage:
    name: Process Hardware Coverage
    needs: [test, hardware-test]
    runs-on: ubuntu-22.04-arm
    # Only run if hardware-test ran
    if: needs.hardware-test.result == 'success' || needs.hardware-test.result == 'failure'
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e  # master
        with:
          toolchain: stable
          components: llvm-tools-preview

      - name: Download Rust instrumented objects (for coverage processing)
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          name: rust-llvm-cov-aarch64
          path: target/llvm-cov-target/

      - name: Download hardware coverage artifacts (contains profraw files)
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          name: coverage-hardware
          path: coverage-hardware/

      - name: Process profraw files into coverage report
        run: |
          echo "=== Downloaded llvm-cov-target directory ==="
          ls -la target/llvm-cov-target/ || echo "Directory not found"
          
          echo ""
          echo "=== Profraw files from hardware ==="
          find coverage-hardware/ -name "*.profraw" -type f || echo "No profraw files found"
          
          PROFRAW_COUNT=$(find coverage-hardware/ -name "*.profraw" | wc -l)
          echo "Found $PROFRAW_COUNT profraw files"
          
          if [ "$PROFRAW_COUNT" -eq 0 ]; then
            echo "WARNING: No profraw files found from hardware tests - skipping coverage"
            exit 0
          fi
          
          # Find LLVM tools from Rust toolchain
          TOOLCHAIN_ROOT=$(rustc --print sysroot)
          LLVM_PROFDATA=$(find "$TOOLCHAIN_ROOT" -name "llvm-profdata" -type f | head -1)
          LLVM_COV=$(find "$TOOLCHAIN_ROOT" -name "llvm-cov" -type f | head -1)
          
          if [ -z "$LLVM_PROFDATA" ] || [ -z "$LLVM_COV" ]; then
            echo "ERROR: Could not find LLVM tools in Rust toolchain"
            exit 1
          fi
          
          echo ""
          echo "Using LLVM tools:"
          echo "  llvm-profdata: $LLVM_PROFDATA"
          echo "  llvm-cov: $LLVM_COV"
          
          # Merge profraw files into profdata
          echo ""
          echo "=== Merging profraw files ==="
          mkdir -p coverage
          "$LLVM_PROFDATA" merge -sparse \
            $(find coverage-hardware/ -name "*.profraw" -type f) \
            -o coverage/hardware.profdata
          
          if [ ! -f coverage/hardware.profdata ]; then
            echo "ERROR: Failed to merge profraw files"
            exit 1
          fi
          echo "Created coverage/hardware.profdata"
          
          # Find all instrumented binaries
          echo ""
          echo "=== Finding instrumented binaries ==="
          OBJECT_FILES=""
          for obj in $(find target/llvm-cov-target/debug/deps -maxdepth 1 -type f ! -name "*.d" ! -name "*.rlib" ! -name "*.rmeta" 2>/dev/null); do
            if file "$obj" | grep -q "ELF"; then
              if [ -z "$OBJECT_FILES" ]; then
                OBJECT_FILES="$obj"
              else
                OBJECT_FILES="$OBJECT_FILES --object=$obj"
              fi
            fi
          done

          if [ -z "$OBJECT_FILES" ]; then
            echo "ERROR: No ELF binaries found in target/llvm-cov-target/debug/deps/"
            exit 1
          fi
          
          echo "Found binaries for coverage analysis"
          
          # Generate coverage report
          echo ""
          echo "=== Generating coverage report ==="
          "$LLVM_COV" export \
            --format=lcov \
            --instr-profile=coverage/hardware.profdata \
            --ignore-filename-regex='/.cargo/registry|/rustc/' \
            $OBJECT_FILES \
            > coverage/coverage-hardware.lcov
          
          if [ ! -s coverage/coverage-hardware.lcov ]; then
            echo "ERROR: Failed to generate coverage report (empty file)"
            exit 1
          fi
          
          echo "Generated coverage/coverage-hardware.lcov"
          wc -l coverage/coverage-hardware.lcov

      - name: Upload processed hardware coverage
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: coverage-hardware-processed
          path: |
            coverage/coverage-hardware.lcov
          retention-days: 30

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-22.04
    needs: [test, hardware-test, process-hardware-coverage]
    # Run if test succeeded, even if hardware tests were skipped
    if: |
      always() && 
      needs.test.result == 'success' &&
      (github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository)

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Download coverage artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          pattern: coverage-*
          path: coverage/

      - name: Organize coverage files for SonarCloud
        run: |
          echo "=== Downloaded coverage artifacts ==="
          find coverage/ -type f
          echo ""
          
          # Collect all coverage reports
          COVERAGE_REPORTS=$(find coverage/ -name "*.xml" -o -name "*.lcov" | tr '\n' ',' | sed 's/,$//')
          
          echo "=== Coverage report paths ==="
          echo "Coverage reports: $COVERAGE_REPORTS"
          
          # Show sample coverage report
          SAMPLE_REPORT=$(find coverage/ -name "*.xml" -o -name "*.lcov" | head -1)
          if [ -n "$SAMPLE_REPORT" ] && [ -f "$SAMPLE_REPORT" ]; then
            echo ""
            echo "=== Sample coverage report (first 20 lines) ==="
            head -20 "$SAMPLE_REPORT"
          fi
          
          # Export for SonarCloud
          echo "COVERAGE_PATHS=$COVERAGE_REPORTS" >> $GITHUB_ENV

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602  # v6.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.rust.lcov.reportPaths=${{ env.COVERAGE_PATHS }}

      - name: Generate coverage summary
        if: always()
        run: |
          echo "# ðŸ“Š BNO08x Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test results are now displayed by Test Reporter action
          echo "> Test results are displayed in the \"Test Results\" check runs above" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test Platforms
          echo "## ðŸ”§ Test Platforms" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Architecture | Environment | Test Types |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------------|-------------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ubuntu 22.04 | x86_64 | GitHub Runner | Unit tests (offline), doc tests |" >> $GITHUB_STEP_SUMMARY
          echo "| Ubuntu 22.04 ARM | aarch64 | GitHub ARM Runner | Unit tests (offline), doc tests |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.hardware-test.result }}" != "skipped" ]; then
            echo "| Raivin | aarch64 | Real Hardware | Integration tests (online) with BNO08x IMU |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Coverage Summary
          echo "## ðŸ“ˆ Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Parse coverage from LCOV files
          for coverage_file in $(find coverage/ -path "*/coverage-*/*.lcov" 2>/dev/null | sort); do
            if [ -f "$coverage_file" ]; then
              platform=$(basename "$(dirname "$coverage_file")" | sed 's/coverage-//')

              # Extract coverage metrics from LCOV
              lines_found=$(grep -c "^DA:" "$coverage_file" 2>/dev/null || echo 0)
              lines_hit=$(grep "^DA:" "$coverage_file" | grep -v ",0$" | wc -l 2>/dev/null || echo 0)

              if [ $lines_found -gt 0 ]; then
                line_pct=$(awk "BEGIN {printf \"%.1f\", ($lines_hit / $lines_found) * 100}")

                echo "**$platform**:" >> $GITHUB_STEP_SUMMARY
                echo "- Line coverage: ${line_pct}% (${lines_hit}/${lines_found} lines)" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
          
          # Hardware coverage if available
          if [ -d "coverage/coverage-hardware-processed" ]; then
            hw_lcov=$(find coverage/coverage-hardware-processed -name "*.lcov" 2>/dev/null | head -1)
            if [ -f "$hw_lcov" ]; then
              # Parse LCOV for coverage stats
              lines_found=$(grep -c "^DA:" "$hw_lcov" 2>/dev/null || echo 0)
              lines_hit=$(grep "^DA:" "$hw_lcov" | grep -v ",0$" | wc -l 2>/dev/null || echo 0)
              if [ $lines_found -gt 0 ]; then
                hw_pct=$(awk "BEGIN {printf \"%.1f\", ($lines_hit / $lines_found) * 100}")
                echo "**Hardware (raivin)**:" >> $GITHUB_STEP_SUMMARY
                echo "- Line coverage: ${hw_pct}% (${lines_hit}/${lines_found} lines)" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— External Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“Š SonarCloud Dashboard](https://sonarcloud.io/summary/overall?id=EdgeFirstAI_bno08x-rs&branch=${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“ Coverage by File](https://sonarcloud.io/component_measures?id=EdgeFirstAI_bno08x-rs&metric=coverage&view=list&branch=${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY

